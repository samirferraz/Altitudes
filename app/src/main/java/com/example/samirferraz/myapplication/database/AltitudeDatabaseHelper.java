package com.example.samirferraz.myapplication.database;

import android.content.ContentValues;
import android.content.Context;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteOpenHelper;
import android.support.annotation.NonNull;
import android.util.Log;

import java.util.StringTokenizer;

import static com.example.samirferraz.myapplication.database.AltitudeDatabaseContract.SQL_CREATE_ENTRIES;
import static com.example.samirferraz.myapplication.database.AltitudeDatabaseContract.SQL_DELETE_ENTRIES;
import static com.example.samirferraz.myapplication.database.AltitudeDatabaseContract.LocationEntry;

public class AltitudeDatabaseHelper extends SQLiteOpenHelper {

    // If you change the database schema, you must increment the database version.
    public static final int DATABASE_VERSION = 1;
    public static final String DATABASE_NAME = "Locations.db";

    private static final float ALPHA = 0.001f;

    public AltitudeDatabaseHelper(Context context) {
        super(context, DATABASE_NAME, null, DATABASE_VERSION);
    }

    public void onCreate(SQLiteDatabase db) {
        db.execSQL(SQL_CREATE_ENTRIES);
        String str = "     321.490000    -12.980000      42.64\n" +
                "       321.491000    -12.980000      43.16\n" +
                "       321.492000    -12.980000      43.67\n" +
                "       321.493000    -12.980000      44.19\n" +
                "       321.494000    -12.980000      44.70\n" +
                "       321.495000    -12.980000      45.22\n" +
                "       321.496000    -12.980000      45.74\n" +
                "       321.497000    -12.980000      46.25\n" +
                "       321.498000    -12.980000      46.77\n" +
                "       321.499000    -12.980000      47.28\n" +
                "       321.500000    -12.980000      47.80\n" +
                "       321.490000    -12.981000      43.65\n" +
                "       321.491000    -12.981000      44.10\n" +
                "       321.492000    -12.981000      44.55\n" +
                "       321.493000    -12.981000      45.00\n" +
                "       321.494000    -12.981000      45.45\n" +
                "       321.495000    -12.981000      45.90\n" +
                "       321.496000    -12.981000      46.36\n" +
                "       321.497000    -12.981000      46.81\n" +
                "       321.498000    -12.981000      47.26\n" +
                "       321.499000    -12.981000      47.71\n" +
                "       321.500000    -12.981000      48.16\n" +
                "       321.490000    -12.982000      44.66\n" +
                "       321.491000    -12.982000      45.04\n" +
                "       321.492000    -12.982000      45.43\n" +
                "       321.493000    -12.982000      45.82\n" +
                "       321.494000    -12.982000      46.20\n" +
                "       321.495000    -12.982000      46.59\n" +
                "       321.496000    -12.982000      46.97\n" +
                "       321.497000    -12.982000      47.36\n" +
                "       321.498000    -12.982000      47.75\n" +
                "       321.499000    -12.982000      48.13\n" +
                "       321.500000    -12.982000      48.52\n" +
                "       321.490000    -12.983000      45.66\n" +
                "       321.491000    -12.983000      45.99\n" +
                "       321.492000    -12.983000      46.31\n" +
                "       321.493000    -12.983000      46.63\n" +
                "       321.494000    -12.983000      46.95\n" +
                "       321.495000    -12.983000      47.27\n" +
                "       321.496000    -12.983000      47.59\n" +
                "       321.497000    -12.983000      47.92\n" +
                "       321.498000    -12.983000      48.24\n" +
                "       321.499000    -12.983000      48.56\n" +
                "       321.500000    -12.983000      48.88\n" +
                "       321.490000    -12.984000      45.82\n" +
                "       321.491000    -12.984000      46.08\n" +
                "       321.492000    -12.984000      46.35\n" +
                "       321.493000    -12.984000      46.62\n" +
                "       321.494000    -12.984000      46.88\n" +
                "       321.495000    -12.984000      47.15\n" +
                "       321.496000    -12.984000      47.41\n" +
                "       321.497000    -12.984000      47.68\n" +
                "       321.498000    -12.984000      47.95\n" +
                "       321.499000    -12.984000      48.21\n" +
                "       321.500000    -12.984000      48.48\n" +
                "       321.490000    -12.985000      45.54\n" +
                "       321.491000    -12.985000      45.76\n" +
                "       321.492000    -12.985000      45.97\n" +
                "       321.493000    -12.985000      46.19\n" +
                "       321.494000    -12.985000      46.40\n" +
                "       321.495000    -12.985000      46.62\n" +
                "       321.496000    -12.985000      46.84\n" +
                "       321.497000    -12.985000      47.05\n" +
                "       321.498000    -12.985000      47.27\n" +
                "       321.499000    -12.985000      47.48\n" +
                "       321.500000    -12.985000      47.70\n" +
                "       321.490000    -12.986000      45.26\n" +
                "       321.491000    -12.986000      45.43\n" +
                "       321.492000    -12.986000      45.60\n" +
                "       321.493000    -12.986000      45.76\n" +
                "       321.494000    -12.986000      45.93\n" +
                "       321.495000    -12.986000      46.09\n" +
                "       321.496000    -12.986000      46.26\n" +
                "       321.497000    -12.986000      46.42\n" +
                "       321.498000    -12.986000      46.59\n" +
                "       321.499000    -12.986000      46.75\n" +
                "       321.500000    -12.986000      46.92\n" +
                "       321.490000    -12.987000      44.99\n" +
                "       321.491000    -12.987000      45.10\n" +
                "       321.492000    -12.987000      45.22\n" +
                "       321.493000    -12.987000      45.33\n" +
                "       321.494000    -12.987000      45.45\n" +
                "       321.495000    -12.987000      45.56\n" +
                "       321.496000    -12.987000      45.68\n" +
                "       321.497000    -12.987000      45.79\n" +
                "       321.498000    -12.987000      45.91\n" +
                "       321.499000    -12.987000      46.02\n" +
                "       321.500000    -12.987000      46.14\n" +
                "       321.490000    -12.988000      44.71\n" +
                "       321.491000    -12.988000      44.78\n" +
                "       321.492000    -12.988000      44.84\n" +
                "       321.493000    -12.988000      44.91\n" +
                "       321.494000    -12.988000      44.97\n" +
                "       321.495000    -12.988000      45.04\n" +
                "       321.496000    -12.988000      45.10\n" +
                "       321.497000    -12.988000      45.17\n" +
                "       321.498000    -12.988000      45.23\n" +
                "       321.499000    -12.988000      45.30\n" +
                "       321.500000    -12.988000      45.36\n" +
                "       321.490000    -12.989000      44.44\n" +
                "       321.491000    -12.989000      44.45\n" +
                "       321.492000    -12.989000      44.46\n" +
                "       321.493000    -12.989000      44.48\n" +
                "       321.494000    -12.989000      44.49\n" +
                "       321.495000    -12.989000      44.51\n" +
                "       321.496000    -12.989000      44.52\n" +
                "       321.497000    -12.989000      44.54\n" +
                "       321.498000    -12.989000      44.55\n" +
                "       321.499000    -12.989000      44.57\n" +
                "       321.500000    -12.989000      44.58\n" +
                "       321.490000    -12.990000      44.16\n" +
                "       321.491000    -12.990000      44.12\n" +
                "       321.492000    -12.990000      44.09\n" +
                "       321.493000    -12.990000      44.05\n" +
                "       321.494000    -12.990000      44.02\n" +
                "       321.495000    -12.990000      43.98\n" +
                "       321.496000    -12.990000      43.94\n" +
                "       321.497000    -12.990000      43.91\n" +
                "       321.498000    -12.990000      43.87\n" +
                "       321.499000    -12.990000      43.84\n" +
                "       321.500000    -12.990000      43.80\n" +
                "       321.490000    -12.991000      43.88\n" +
                "       321.491000    -12.991000      43.80\n" +
                "       321.492000    -12.991000      43.71\n" +
                "       321.493000    -12.991000      43.62\n" +
                "       321.494000    -12.991000      43.54\n" +
                "       321.495000    -12.991000      43.45\n" +
                "       321.496000    -12.991000      43.37\n" +
                "       321.497000    -12.991000      43.28\n" +
                "       321.498000    -12.991000      43.19\n" +
                "       321.499000    -12.991000      43.11\n" +
                "       321.500000    -12.991000      43.02\n" +
                "       321.490000    -12.992000      43.61\n" +
                "       321.491000    -12.992000      43.47\n" +
                "       321.492000    -12.992000      43.33\n" +
                "       321.493000    -12.992000      43.20\n" +
                "       321.494000    -12.992000      43.06\n" +
                "       321.495000    -12.992000      42.92\n" +
                "       321.496000    -12.992000      42.79\n" +
                "       321.497000    -12.992000      42.65\n" +
                "       321.498000    -12.992000      42.51\n" +
                "       321.499000    -12.992000      42.38\n" +
                "       321.500000    -12.992000      42.24\n" +
                "       321.490000    -12.993000      43.33\n" +
                "       321.491000    -12.993000      43.14\n" +
                "       321.492000    -12.993000      42.96\n" +
                "       321.493000    -12.993000      42.77\n" +
                "       321.494000    -12.993000      42.58\n" +
                "       321.495000    -12.993000      42.40\n" +
                "       321.496000    -12.993000      42.21\n" +
                "       321.497000    -12.993000      42.02\n" +
                "       321.498000    -12.993000      41.83\n" +
                "       321.499000    -12.993000      41.65\n" +
                "       321.500000    -12.993000      41.46\n" +
                "       321.490000    -12.994000      43.06\n" +
                "       321.491000    -12.994000      42.82\n" +
                "       321.492000    -12.994000      42.58\n" +
                "       321.493000    -12.994000      42.34\n" +
                "       321.494000    -12.994000      42.11\n" +
                "       321.495000    -12.994000      41.87\n" +
                "       321.496000    -12.994000      41.63\n" +
                "       321.497000    -12.994000      41.39\n" +
                "       321.498000    -12.994000      41.16\n" +
                "       321.499000    -12.994000      40.92\n" +
                "       321.500000    -12.994000      40.68\n" +
                "       321.490000    -12.995000      42.78\n" +
                "       321.491000    -12.995000      42.49\n" +
                "       321.492000    -12.995000      42.20\n" +
                "       321.493000    -12.995000      41.92\n" +
                "       321.494000    -12.995000      41.63\n" +
                "       321.495000    -12.995000      41.34\n" +
                "       321.496000    -12.995000      41.05\n" +
                "       321.497000    -12.995000      40.76\n" +
                "       321.498000    -12.995000      40.48\n" +
                "       321.499000    -12.995000      40.19\n" +
                "       321.500000    -12.995000      39.90\n" +
                "       321.490000    -12.996000      42.50\n" +
                "       321.491000    -12.996000      42.17\n" +
                "       321.492000    -12.996000      41.83\n" +
                "       321.493000    -12.996000      41.49\n" +
                "       321.494000    -12.996000      41.15\n" +
                "       321.495000    -12.996000      40.81\n" +
                "       321.496000    -12.996000      40.47\n" +
                "       321.497000    -12.996000      40.14\n" +
                "       321.498000    -12.996000      39.80\n" +
                "       321.499000    -12.996000      39.46\n" +
                "       321.500000    -12.996000      39.12\n" +
                "       321.490000    -12.997000      42.23\n" +
                "       321.491000    -12.997000      41.84\n" +
                "       321.492000    -12.997000      41.45\n" +
                "       321.493000    -12.997000      41.06\n" +
                "       321.494000    -12.997000      40.67\n" +
                "       321.495000    -12.997000      40.28\n" +
                "       321.496000    -12.997000      39.90\n" +
                "       321.497000    -12.997000      39.51\n" +
                "       321.498000    -12.997000      39.12\n" +
                "       321.499000    -12.997000      38.73\n" +
                "       321.500000    -12.997000      38.34\n" +
                "       321.490000    -12.998000      41.95\n" +
                "       321.491000    -12.998000      41.51\n" +
                "       321.492000    -12.998000      41.07\n" +
                "       321.493000    -12.998000      40.63\n" +
                "       321.494000    -12.998000      40.20\n" +
                "       321.495000    -12.998000      39.76\n" +
                "       321.496000    -12.998000      39.32\n" +
                "       321.497000    -12.998000      38.88\n" +
                "       321.498000    -12.998000      38.44\n" +
                "       321.499000    -12.998000      38.00\n" +
                "       321.500000    -12.998000      37.56\n" +
                "       321.490000    -12.999000      41.68\n" +
                "       321.491000    -12.999000      41.19\n" +
                "       321.492000    -12.999000      40.70\n" +
                "       321.493000    -12.999000      40.21\n" +
                "       321.494000    -12.999000      39.72\n" +
                "       321.495000    -12.999000      39.23\n" +
                "       321.496000    -12.999000      38.74\n" +
                "       321.497000    -12.999000      38.25\n" +
                "       321.498000    -12.999000      37.76\n" +
                "       321.499000    -12.999000      37.27\n" +
                "       321.500000    -12.999000      36.78\n" +
                "       321.490000    -13.000000      41.40\n" +
                "       321.491000    -13.000000      40.86\n" +
                "       321.492000    -13.000000      40.32\n" +
                "       321.493000    -13.000000      39.78\n" +
                "       321.494000    -13.000000      39.24\n" +
                "       321.495000    -13.000000      38.70\n" +
                "       321.496000    -13.000000      38.16\n" +
                "       321.497000    -13.000000      37.62\n" +
                "       321.498000    -13.000000      37.08\n" +
                "       321.499000    -13.000000      36.54\n" +
                "       321.500000    -13.000000      36.00\n" +
                "       321.490000    -13.001000      38.59\n" +
                "       321.491000    -13.001000      38.10\n" +
                "       321.492000    -13.001000      37.61\n" +
                "       321.493000    -13.001000      37.11\n" +
                "       321.494000    -13.001000      36.62\n" +
                "       321.495000    -13.001000      36.13\n" +
                "       321.496000    -13.001000      35.63\n" +
                "       321.497000    -13.001000      35.14\n" +
                "       321.498000    -13.001000      34.65\n" +
                "       321.499000    -13.001000      34.15\n" +
                "       321.500000    -13.001000      33.66\n" +
                "       321.490000    -13.002000      35.78\n" +
                "       321.491000    -13.002000      35.34\n" +
                "       321.492000    -13.002000      34.89\n" +
                "       321.493000    -13.002000      34.44\n" +
                "       321.494000    -13.002000      34.00\n" +
                "       321.495000    -13.002000      33.55\n" +
                "       321.496000    -13.002000      33.11\n" +
                "       321.497000    -13.002000      32.66\n" +
                "       321.498000    -13.002000      32.21\n" +
                "       321.499000    -13.002000      31.77\n" +
                "       321.500000    -13.002000      31.32\n" +
                "       321.490000    -13.003000      32.98\n" +
                "       321.491000    -13.003000      32.58\n" +
                "       321.492000    -13.003000      32.18\n" +
                "       321.493000    -13.003000      31.78\n" +
                "       321.494000    -13.003000      31.38\n" +
                "       321.495000    -13.003000      30.98\n" +
                "       321.496000    -13.003000      30.58\n" +
                "       321.497000    -13.003000      30.18\n" +
                "       321.498000    -13.003000      29.78\n" +
                "       321.499000    -13.003000      29.38\n" +
                "       321.500000    -13.003000      28.98\n" +
                "       321.490000    -13.004000      30.17\n" +
                "       321.491000    -13.004000      29.82\n" +
                "       321.492000    -13.004000      29.46\n" +
                "       321.493000    -13.004000      29.11\n" +
                "       321.494000    -13.004000      28.76\n" +
                "       321.495000    -13.004000      28.40\n" +
                "       321.496000    -13.004000      28.05\n" +
                "       321.497000    -13.004000      27.70\n" +
                "       321.498000    -13.004000      27.35\n" +
                "       321.499000    -13.004000      26.99\n" +
                "       321.500000    -13.004000      26.64\n" +
                "       321.490000    -13.005000      27.36\n" +
                "       321.491000    -13.005000      27.05\n" +
                "       321.492000    -13.005000      26.75\n" +
                "       321.493000    -13.005000      26.44\n" +
                "       321.494000    -13.005000      26.14\n" +
                "       321.495000    -13.005000      25.83\n" +
                "       321.496000    -13.005000      25.52\n" +
                "       321.497000    -13.005000      25.22\n" +
                "       321.498000    -13.005000      24.91\n" +
                "       321.499000    -13.005000      24.61\n" +
                "       321.500000    -13.005000      24.30\n" +
                "       321.490000    -13.006000      24.55\n" +
                "       321.491000    -13.006000      24.29\n" +
                "       321.492000    -13.006000      24.03\n" +
                "       321.493000    -13.006000      23.77\n" +
                "       321.494000    -13.006000      23.52\n" +
                "       321.495000    -13.006000      23.26\n" +
                "       321.496000    -13.006000      23.00\n" +
                "       321.497000    -13.006000      22.74\n" +
                "       321.498000    -13.006000      22.48\n" +
                "       321.499000    -13.006000      22.22\n" +
                "       321.500000    -13.006000      21.96\n" +
                "       321.490000    -13.007000      21.74\n" +
                "       321.491000    -13.007000      21.53\n" +
                "       321.492000    -13.007000      21.32\n" +
                "       321.493000    -13.007000      21.11\n" +
                "       321.494000    -13.007000      20.89\n" +
                "       321.495000    -13.007000      20.68\n" +
                "       321.496000    -13.007000      20.47\n" +
                "       321.497000    -13.007000      20.26\n" +
                "       321.498000    -13.007000      20.04\n" +
                "       321.499000    -13.007000      19.83\n" +
                "       321.500000    -13.007000      19.62\n" +
                "       321.490000    -13.008000      18.94\n" +
                "       321.491000    -13.008000      18.77\n" +
                "       321.492000    -13.008000      18.60\n" +
                "       321.493000    -13.008000      18.44\n" +
                "       321.494000    -13.008000      18.27\n" +
                "       321.495000    -13.008000      18.11\n" +
                "       321.496000    -13.008000      17.94\n" +
                "       321.497000    -13.008000      17.78\n" +
                "       321.498000    -13.008000      17.61\n" +
                "       321.499000    -13.008000      17.45\n" +
                "       321.500000    -13.008000      17.28\n" +
                "       321.490000    -13.009000      16.13\n" +
                "       321.491000    -13.009000      16.01\n" +
                "       321.492000    -13.009000      15.89\n" +
                "       321.493000    -13.009000      15.77\n" +
                "       321.494000    -13.009000      15.65\n" +
                "       321.495000    -13.009000      15.53\n" +
                "       321.496000    -13.009000      15.42\n" +
                "       321.497000    -13.009000      15.30\n" +
                "       321.498000    -13.009000      15.18\n" +
                "       321.499000    -13.009000      15.06\n" +
                "       321.500000    -13.009000      14.94\n" +
                "       321.490000    -13.010000      13.32\n" +
                "       321.491000    -13.010000      13.25\n" +
                "       321.492000    -13.010000      13.18\n" +
                "       321.493000    -13.010000      13.10\n" +
                "       321.494000    -13.010000      13.03\n" +
                "       321.495000    -13.010000      12.96\n" +
                "       321.496000    -13.010000      12.89\n" +
                "       321.497000    -13.010000      12.82\n" +
                "       321.498000    -13.010000      12.74\n" +
                "       321.499000    -13.010000      12.67\n" +
                "       321.500000    -13.010000      12.60";
        addLocations(str, db);
    }

    public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
        // This database is only a cache for online data, so its upgrade policy is
        // to simply to discard the data and start over
        db.execSQL(SQL_DELETE_ENTRIES);
        onCreate(db);
    }

    public void onDowngrade(SQLiteDatabase db, int oldVersion, int newVersion) {
        onUpgrade(db, oldVersion, newVersion);
    }

    public void addLocation(float lat, float lng, float alt) {
        SQLiteDatabase database = getWritableDatabase();
        database.beginTransaction();
        try {
            addLocation(lat, lng, alt, database);
            database.setTransactionSuccessful();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            database.endTransaction();
        }

    }

    private void addLocation(float lat, float lng, float alt, SQLiteDatabase database) {
        ContentValues values = new ContentValues();
        values.put(LocationEntry.COLUMN_NAME_LATITUDE, lat);
        values.put(LocationEntry.COLUMN_NAME_LONGITUDE, lng >= 180 ? lng - 360 : lng);
        values.put(LocationEntry.COLUMN_NAME_ALTITUDE, alt);

        database.insert(LocationEntry.TABLE_NAME, null, values);
    }

    public String readLocations() {
        SQLiteDatabase db = getReadableDatabase();

        String[] projection = {
                LocationEntry._ID,
                LocationEntry.COLUMN_NAME_LATITUDE,
                LocationEntry.COLUMN_NAME_LONGITUDE,
                LocationEntry.COLUMN_NAME_ALTITUDE
        };

//        String selection = LocationEntry.COLUMN_NAME_TITLE + " = ?";
//        String[] selectionArgs = { "My Title" };

        Cursor c = db.query(
                LocationEntry.TABLE_NAME,                     // The table to query
                projection,                               // The columns to return
//                selection,                                // The columns for the WHERE clause
                null,
//                selectionArgs,                            // The values for the WHERE clause
                null,
                null,                                     // don't group the rows
                null,                                     // don't filter by row groups
                null  // The sort order
        );

        Log.d("DBHELPER", " -------------------------- ");

        return getCursorString(c);
    }

    @NonNull
    private String getCursorString(Cursor c) {
        StringBuffer sb = new StringBuffer();
        while (c.moveToNext()) {
            sb.append("\n");
            sb.append(String.format("ID: %1$d, Latitude: %2$.3f Long: %3$.3f Altitude: %4$.3f ", c.getLong(0), c.getFloat(1), c.getFloat(2), c.getFloat(3)));
        }

        c.close();

        return sb.toString();
    }

    private void addLocations(String locations, SQLiteDatabase database) {
        String[] lines = locations.split("\n");
        database.beginTransaction();
        try {
            for (String line : lines) {
                StringTokenizer tokens = new StringTokenizer(line, " ");
                if (tokens.countTokens() == 3) {
                    Float lng = Float.valueOf(tokens.nextToken());
                    Float lat = Float.valueOf(tokens.nextToken());
                    Float alt = Float.valueOf(tokens.nextToken());
                    addLocation(lat, lng, alt, database);
                }
            }
            database.setTransactionSuccessful();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            database.endTransaction();
        }
    }

    public float getAltitude(float lat, float lng) {
        Cursor c = getAltitudePoints(lat, lng);

        Log.d("DBHELPER", " -------------------------- ");

        float totalAltitude = 0f;
        try {
            if (c.getCount() == 4) {
                while (c.moveToNext()) {
                    Log.d("DBHELPER", String.format("ID: %1$d, Latitude: %2$.3f Long: %3$.3f Altitude: %4$.3f ", c.getLong(0), c.getFloat(1), c.getFloat(2), c.getFloat(3)));
                    totalAltitude += c.getFloat(3);
                }
            }
        } catch (Exception e) {
            totalAltitude = 0f;
        } finally {
            c.close();
        }

        return totalAltitude / 4;
    }

    public String getPrintableAltitudePoints(float lat, float lng) {
        Cursor c = getAltitudePoints(lat, lng);
        return getCursorString(c);
    }

    private Cursor getAltitudePoints(float lat, float lng) {
        SQLiteDatabase db = getReadableDatabase();

        String[] projection = {
                LocationEntry._ID,
                LocationEntry.COLUMN_NAME_LATITUDE,
                LocationEntry.COLUMN_NAME_LONGITUDE,
                LocationEntry.COLUMN_NAME_ALTITUDE
        };

        String selection = LocationEntry.COLUMN_NAME_LATITUDE + " > ? AND " +
        LocationEntry.COLUMN_NAME_LATITUDE + " < ? AND " +
        LocationEntry.COLUMN_NAME_LONGITUDE + " > ? AND " +
        LocationEntry.COLUMN_NAME_LONGITUDE + " < ?";
        String[] selectionArgs = {
                String.valueOf(lat - ALPHA),
                String.valueOf(lat + ALPHA),
                String.valueOf(lng - ALPHA),
                String.valueOf(lng + ALPHA)
        };

        return db.query(
                LocationEntry.TABLE_NAME,                     // The table to query
                projection,                               // The columns to return
                selection,                                // The columns for the WHERE clause
                selectionArgs,                            // The values for the WHERE clause
                null,                                     // don't group the rows
                null,                                     // don't filter by row groups
                null  // The sort order
        );
    }
}